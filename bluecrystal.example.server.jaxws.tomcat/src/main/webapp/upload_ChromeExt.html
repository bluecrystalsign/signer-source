<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" >

<!--
    Blue Crystal: Document Digital Signature
    Copyright (C) 2007-2015  Sergio Leal

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<html>
<head>
<title>Rest Signer - Assinatura com Politica de Assinatura
	(ICP-Brasil)</title>
<script type="text/javascript"
	src="http://code.jquery.com/jquery-1.10.1.min.js"></script>


<script>
            window.onload = function() {
                var dropbox = document.getElementById("dropbox");
                dropbox.addEventListener("dragenter", noop, false);
                dropbox.addEventListener("dragexit", noop, false);
                dropbox.addEventListener("dragover", noop, false);
                dropbox.addEventListener("drop", dropUpload, false);
            }

            function noop(event) {
                event.stopPropagation();
                event.preventDefault();
            }

            function dropUpload(event) {
                noop(event);
                var files = event.dataTransfer.files;

                for (var i = 0; i < files.length; i++) {
                    upload(files[i]);
                }
            }

            function upload(file) {
                document.getElementById("status").innerHTML = "Uploading " + file.name;

                var formData = new FormData();
                formData.append("file", file);

                var xhr = new XMLHttpRequest();
                xhr.upload.addEventListener("progress", uploadProgress, false);
                xhr.addEventListener("load", uploadComplete, false);
                xhr.open("POST", "uploadServlet", true); // If async=false, then you'll miss progress bar support.
                xhr.send(formData);
            }

            function uploadProgress(event) {
                // Note: doesn't work with async=false.
                var progress = Math.round(event.loaded / event.total * 100);
                document.getElementById("status").innerHTML = "Progress " + progress + "%";
            }

            function uploadComplete(event) {
                document.getElementById("status").innerHTML = event.target.responseText;
                assinar();
            }
        </script>
<style>
#dropbox {
	width: 300px;
	height: 200px;
	border: 1px solid gray;
	border-radius: 5px;
	padding: 5px;
	color: gray;
}
</style>



</head>
<body>



	<script type="text/javascript">

$(document).ready(function() {

	try
	{
		isActive();
	}
	catch(Err)
	{

		alert('Erro (catch): ' + Err);
	}


});

function isActive(){
	 $.ajax({
	        type: 'GET',
	        url: 'http://localhost:8612/test',
	        data: {},
	        success: function (data) {
	        return true;	
	        	
	        },
      error: function (error) {
    	  alert('error: Não foi possivel contactar o restSigner');
          return false;
      }
	});
	
}


function createEnvelope(certificate, payload, hashAlg, time_value, hash_value, sign)
{
	<!-- STEP 5: CREATE ENV -->
	$.ajax({
		 type: 'GET',
	        url: 'CreateEnvelope',
	        data: {
	        	hash_value: hash_value,
	        	time_value: time_value,
	        	sa_value: payload,
	        	signed_value: sign,
	        	cert: certificate,
	        	alg: hashAlg
	        },
	        success: function (data) {
	        	var json = $.parseJSON(data);
	        	var signedContent = json.signedContent;
	        	var isOk = json.isOk;
	        	var certB64 =  json.certB64;
	        	var certSubject =  json.certSubject;
	        	if(isOk){
	        		 $("#signedEnvelope").text(signedContent);
	        	 } else {
	        		 alert('Assinatura inválida');
	        	 }
	        },
            error: function (error) {
                alert('error: ' + eval(error));
            }

		});

	
}

function signContent(certificate, thumbprint, payload, hashAlg, time_value, hash_value)
{
    $.ajax({
        type: 'GET',
        dataType: 'json',
        url: 'http://localhost:8612/sign',
        data: { certificate: certificate,
        	thumbprint: thumbprint,
        	payload: payload,
        	hashAlg :hashAlg},
        success: function (data) {
           
        	createEnvelope(certificate, payload, hashAlg, time_value, hash_value, data.sign);
	
	        },
            error: function (error) {
                alert('error: ' + eval(error));
            }
     });
	
}

function loadSignature(certificate, thumbprint, hashAlg)
{
	$.ajax({
        type: 'GET',
        url: 'LoadSignature',
        data: { cert: certificate,
        	alg: hashAlg},
        success: function (data) {
           
            hash_value =  data.hash_value;
            time_value = data.time_value;
            sa_value = data.sa_value;
            
            
            signContent(certificate, thumbprint, sa_value,hashAlg, time_value, hash_value);

            <!-- End Sign -->
	
	        },
            error: function (error) {
                alert('error: ' + eval(error));
            }
     });
	
}

var alg = 'sha1';
var cert_thumb = '';
var cert_content = '';

function loadCert(){
	$.ajax({
	        type: 'GET',
	        url: 'http://localhost:8612/cert',
	        data: {},
	        success: function (data) {
	        	cert_thumb = data.thumbprint;
	        	cert_content = data.certificate

			getKeySize(data.thumbprint); 	        	
        	<!-- parseCert -->
        	
        	parseCert(data.certificate);
        	
        	<!-- Fim do Cert (1) -->
        	
	        }
	       });
	
}

function getKeySize(thumbprint){
	
 	<!-- keySize -->
  	 $.ajax({
        type: 'GET',
        url: 'http://localhost:8612/keySize',
        data: {thumbprint : thumbprint},
        success: function (data) {
        	
            
			if(data.size >= 2048){
				alg = 'sha256';
			}
			loadSignature(cert_content, cert_thumb, alg);
        },
     error: function (error) {
         alert('error: Não foi possivel contactar o restSigner');
     }
	});

}

function parseCert(certificate){
	$.ajax({
        type: 'GET',
        url: 'ParseCert',
        data: {cert:  certificate},
        success: function (data) {
        	var json = $.parseJSON(data);
        	var html = '<table><tr><th>Nome</th><th>Valor</th></tr>';
        	 
        	for(var i = 0; i < json.length; i++){
	        	html += '<tr><td>'+json[i].name+'</td><td>'+json[i].value+'</td></tr>';
        	 }
        	 html += '</table>';
        	 $("#parsedCert").html(html);

        },
        error: function (error) {
            alert('error: ' + eval(error));
        }
	});
}

function assinar()
{
	try
		{
			loadCert();
		 
    	<!-- 1 do Cert -->

		}
		catch(Err)
		{

			alert('Erro (catch): ' + Err);
		}
}
</script>
	ActiveX - Assinatura com Politica de Assinatura(ICP-Brasil)
	<br>Powered by
	<b>BluC</b>
	<br>

	<h1>Para testar com outra tecnologia escolha um dos links abaixo.</h1>
	<a href="upload_activexNoSP.html">ActiveX - Assinatura sem Politica
		de Assinatura</a>
	<br />
	<a href="upload_java_capi.html">Applet Java (MS-CAPI) - Assinatura
		com Politica de Assinatura(ICP-Brasil)</a>
	<br />
	<a href="upload_java_capiNoSP.html">Applet Java (MS-CAPI) -
		Assinatura sem Politica de Assinatura</a>
	<br />
	<a href="upload_java_p11.html">Applet Java (PKCS#11) - Assinatura
		com Politica de Assinatura(ICP-Brasil)</a>
	<br />
	<a href="upload_java_p11NoSP.html">Applet Java (PKCS#11) -
		Assinatura sem Politica de Assinatura</a>
	<br />

	<h1>Passo 1: Arraste um documento para a area abaixo.</h1>
	<div id="dropbox">Arraste o arquivo que deseja assinar para
		aqui...</div>
	<div id="status"></div>

	<h1>
		Passo 2: Selecione o botão "Assinar"</br>Passo 3: na janela exibida
		selecione o certificado que deseja utilizar e aguarde.</br> Serão exibidos
		os dados do certificado e em seguida das assinatura.
	</h1>
	<p>
	<h1>Certificado</h1>
	<br />
	<span id="parsedCert">...</span>
	<p>
	<p>
	<h1>Assinatura</h1>
	<br />
	<span id="signedEnvelope">...</span>
	<p>
</body>
</html>
